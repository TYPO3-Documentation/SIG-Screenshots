#!/bin/bash

## Description: Make screenshots via codeception inside the web container
## Usage: make-screenshots
## Example: make-screenshots\nmake-screenshots -s Styleguide\nmake-screenshots -s Styleguide -a actionsIdentifierScreenshots\nmake-screenshots -t My-Manual
## Flags: [{"Name":"actions-id","Shorthand":"a","Usage":"Run actions of specific ID only. Actions of all IDs if empty."},{"Name":"suite","Shorthand":"s","Usage":"Run actions of specific TYPO3 environment suite only (Core, Examples, Install, Introduction, Styleguide). All suites if empty."},{"Name":"target-path","Shorthand":"t","Usage":"Run actions of specific folder only (relative or absolute path). All folders if empty."}]

SUITE=""
TARGET_PATH=""
ACTIONS_ID=""

fetch_options() {
    local params;
    local exitStatus;

    params=$(getopt --options s:a:t: --longoptions suite:,actions-id:target-path: --name "$0" -- "$@")

    exitStatus=$?
    if [ $exitStatus -eq 0 ]; then
        eval set -- "$params"

        while true
        do
            case "$1" in
                -s|--suite)
                    SUITE=$2
                    shift 2
                    ;;
                -a|--actions-id)
                    ACTIONS_ID=$2
                    shift 2
                    ;;
                -t|--target-path)
                    TARGET_PATH=$2
                    shift 2
                    ;;
                --)
                    shift
                    ;;
                "")
                    break
                    ;;
                *)
                    echo "Invalid argument: '$1'" >&2
                    exitStatus=1
                    shift
                    ;;
            esac
        done
    fi

    if [ $exitStatus -ne 0 ]; then
        echo "Call \"make-screenshots --help\" to display help and valid options."
        exit $exitStatus
    fi
}

cleanup_screenshots() {
    typo3 screenshots:cleanup
}

make_screenshots() {
    screenshotsPathFilter=$TARGET_PATH \
    screenshotsActionsIdFilter=$ACTIONS_ID \
    typo3InstallMysqlDatabaseName=screenshots_install \
    typo3InstallMysqlDatabaseUsername=root \
    typo3InstallMysqlDatabasePassword=root \
    typo3InstallMysqlDatabaseHost=db \
    typo3DatabaseName=screenshots_backend \
    typo3DatabaseUsername=root \
    typo3DatabasePassword=root \
    typo3DatabaseHost=db \
    vendor/bin/codecept run -d -c public/typo3conf/ext/screenshots/Classes/Runner/codeception.yml $SUITE
}

fetch_options $@
cleanup_screenshots
make_screenshots
